services:
  base:
    image: ghcr.io/dployr-io/dployr-base:latest
    container_name: dployr-base
    user: "0:0"  # Run as root to fix Windows bind mount permissions (not recommended in prod)
    restart: unless-stopped
    ports:
      - "7878:7878"
    environment:      
      # Server
      PORT: "7878"
      HOST: "0.0.0.0"
      BASE_URL: "http://192.168.100.35:7878"  
      APP_URL: "http://192.168.100.35:5173"    
      
      # Database (SQLite - file-based)
      DB_TYPE: "sqlite"
      DB_PATH: "/data/dployr.db"
      
      # KV Store (Redis)
      KV_TYPE: "redis"
      KV_URL: "redis://redis:6379"
      
      # Storage (Filesystem)
      STORAGE_TYPE: "filesystem"
      STORAGE_PATH: "/data/storage"
      
      # Auth - OAuth Providers (OPTIONAL)
      GOOGLE_CLIENT_ID: ""
      GOOGLE_CLIENT_SECRET: ""
      GITHUB_CLIENT_ID: ""
      GITHUB_CLIENT_SECRET: ""
      
      # Email (OPTIONAL)
      EMAIL_PROVIDER: "zepto"
      EMAIL_FROM: "noreply@zeipo.ai"
      ZEPTO_API_KEY: ""

      CORS_ALLOWED_ORIGINS: "http://192.168.100.35:9099,http://192.168.100.20:7879,http://192.168.100.35:7877,http://192.168.100.35:5173"
    volumes:
      - ./data:/data
    depends_on:
      - redis
    networks:
      - dployr-network

  redis:
    image: redis:7-alpine
    container_name: dployr-redis
    restart: unless-stopped
    ports:
      - "6379:6379" 
    volumes:
      - redis-data:/data
    networks:
      - dployr-network

  app:
    image: ghcr.io/dployr-io/dployr-web:latest
    container_name: dployr-web
    restart: unless-stopped
    ports:
      - "7877:80"
    environment:
      DPLOYR_BASE_URL: "http://192.168.100.35:7878"
    depends_on:
      - base
    networks:
      - dployr-network

  docs:
    image: caddy:alpine
    container_name: dployr-api-docs
    restart: unless-stopped
    ports:
      - "9099:80"
    environment:
      DPLOYR_BASE_URL: "http://192.168.100.35:7878"
    volumes:
      - ./docs:/src/docs:ro
    command:
      - sh
      - -c
      - |
          cp -r /src/docs/* /usr/share/caddy/ &&
          sed -i "s#https://base.dployr.dev#${DPLOYR_BASE_URL:-http://192.168.100.35:7878}#" /usr/share/caddy/openapi.yaml &&
          caddy file-server --root /usr/share/caddy --listen :80
    networks:
      - dployr-network

volumes:
  redis-data:

networks:
  dployr-network:
    driver: bridge

# ============================================================
# ALTERNATIVE CONFIGURATIONS (uncomment to use)
# ============================================================

# --- Option 1: Use Upstash Redis (serverless) ---
# Replace redis service and update dployr-base env:
#   KV_TYPE: "upstash"
#   KV_REST_URL: "https://your-upstash-url.upstash.io"
#   KV_REST_TOKEN: "your-upstash-token"
# Then remove the redis service entirely

# --- Option 2: Use S3-compatible storage ---
# Update dployr-base env:
#   STORAGE_TYPE: "s3"
#   STORAGE_BUCKET: "your-bucket"
#   STORAGE_REGION: "us-east-1"
#   STORAGE_ACCESS_KEY: "your-access-key"
#   STORAGE_SECRET_KEY: "your-secret-key"

# --- Option 3: Use Azure Blob Storage ---
# Update dployr-base env:
#   STORAGE_TYPE: "azure"
#   STORAGE_ACCOUNT: "your-account"
#   STORAGE_KEY: "your-key"
#   STORAGE_CONTAINER: "dployr-logs"
